<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0"
    />
    <title>Aleph</title>
    <script src="/assets/aframe-master.js"></script>
    <script src="https://unpkg.com/three@0.102.1/examples/js/controls/OrbitControls.js"></script>

    <script
      type="module"
      src="https://unpkg.com/@ionic/core@4.7.4/dist/ionic/ionic.esm.js"
    ></script>
    <script
      nomodule=""
      src="https://unpkg.com/@ionic/core@4.7.4/dist/ionic/ionic.js"
    ></script>

    <script src="/assets/ami.min.js"></script>
    <script type="module" src="/build/aleph.esm.js"></script>
    <script nomodule src="/build/aleph.js"></script>

    <link rel="stylesheet" href="/build/aleph.css" />
    <style>
      *,
      *:before,
      *:after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }

      #container {
        width: 100%;
        height: 100%;
        display: flex;
      }

      #scene {
        flex: 80%;
        color: #fff;
      }

      #debug {
        flex: 20%;
        min-width: 300px;
        padding: 1rem;
        overflow-y: auto;
        max-height: 100%;
        background-color: #f7f7f7;
      }

      #debug h1 {
        margin-top: 0;
        text-align: right;
        color: #b7b7b7;
      }

      #debug section {
        margin: 1rem 0 0 0;
      }

      #debug.disabled {
        pointer-events: none;
        opacity: 0.4;
      }

      .ion-page {
        visibility: visible !important; /* edge fix */
      }

      .rs-base {
        margin-top: 20px;
        position: static;
        width: auto;
      }

      /* al-control-panel {
        --bounding-box-enabled-visibility: hidden;
      } */
    </style>
  </head>
  <body>
    <div id="container">
      <div id="debug" class="disabled">
        <h1>â„µ</h1>
        <al-control-panel></al-control-panel>
      </div>

      <div id="scene">
        <al-viewer
          draco-decoder-path="assets/"
          width="100%"
          height="100%"
        ></al-viewer>
      </div>
    </div>

    <script>

      let container, alControlPanel, alViewer, state;

      let prevState = {};

      const urls = new Map([
        [
          "https://nomad-project.co.uk/objects/collection/toy-lion/_toy-lion/toy-lion.gltf",
          "Lion (GLTF)"
        ],
        [
          "https://iiif-3d-manifests.netlify.com/collection/gltf/woody/_woody/assets/woody.gltf",
          "Fisherman (GLTF)"
        ],
        ["http://files.blokdust.io/test/bowl-draco.glb", "Bowl (DRACO)"],
        [
          "https://aleph-fixtures.netlify.com/collection/dicom/brain/_brain/brain.json",
          "Brain (DICOM)"
        ],
        [
          "https://www.morphosource.org/media/morphosource/dcm_sample/platypus2/dcm_multi_vf300_jpegQ95_16bit_allslices.json",
          "Platypus (DICOM)"
        ],
        [
          "https://www.morphosource.org/media/morphosource/dcm_sample/ptilocercus/dcm_multi_vf300_jpegQ95_16bit_allslices.json",
          "Tree Shrew (DICOM)"
        ],
        [
          "https://aleph-fixtures.netlify.com/collection/gltf/bunny/_bunny/bunny_default_materials.glb",
          "Bunny Default Materials (GLB)"
        ]
      ]);

      function init() {
        container = document.getElementById("container");
        alControlPanel = document.querySelector("al-control-panel");
        alViewer = document.querySelector("al-viewer");

        alControlPanel.urls = urls;

        alViewer.componentOnReady().then(function() {

          // load src when component ready
          nextState({
            src: Array.from(urls)[0][0]
          });

          alViewer.addEventListener(
            "changed",
            function(e) {
              nextState({
                angles: e.detail.angles,
                displayMode: e.detail.displayMode,
                edges: e.detail.edges,
                nodes: e.detail.nodes,
                selected: e.detail.selected,
                srcLoaded: e.detail.srcLoaded
              });
            },
            false
          );

          alViewer.addEventListener(
            "loaded",
            function(ev) {
              if (state.displayMode !== "mesh") {
                alControlPanel.stackhelper = ev.detail;
              }
            },
            false
          );
        });

        alControlPanel.componentOnReady().then(function() {

          alControlPanel.addEventListener(
            "boundingBoxEnabledChanged",
            function(e) {
              alViewer.setBoundingBoxEnabled(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "controlsTypeChanged",
            function(e) {
              alViewer.setControlsType(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "deleteAngle",
            function(e) {
              alViewer.deleteAngle(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "deleteEdge",
            function(e) {
              alViewer.deleteEdge(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "deleteNode",
            function(e) {
              alViewer.deleteNode(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "displayModeChanged",
            function(e) {
              alViewer.setDisplayMode(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "graphEnabledChanged",
            function(e) {
              alViewer.setGraphEnabled(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "materialChanged",
            function(e) {
              alViewer.setMaterial(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "orientationChanged",
            function(e) {
              alViewer.setOrientation(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "recenter",
            function(e) {
              alViewer.recenter();
            },
            false
          );

          alControlPanel.addEventListener(
            "graphSubmitted",
            function(e) {
              const graph = JSON.parse(e.detail);
              if (graph) {
                alViewer.clearGraph();
                alViewer.setGraph(graph);
              }
            },
            false
          );

          alControlPanel.addEventListener(
            "saveNode",
            function(e) {
              alViewer.setNode(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "selectedChanged",
            function(e) {
              alViewer.selectNode(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "slicesIndexChanged",
            function(e) {
              alViewer.setSlicesIndex(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "slicesWindowCenterChanged",
            function(e) {
              alViewer.setSlicesWindowCenter(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "slicesWindowWidthChanged",
            function(e) {
              alViewer.setSlicesWindowWidth(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "unitsChanged",
            function(e) {
              alViewer.setUnits(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "urlChanged",
            function(e) {
              nextState({
                src: e.detail
              });
            },
            false
          );

          alControlPanel.addEventListener(
            "volumeStepsChanged",
            function(e) {
              alViewer.setVolumeSteps(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "volumeWindowCenterChanged",
            function(e) {
              alViewer.setVolumeWindowCenter(e.detail);
            },
            false
          );

          alControlPanel.addEventListener(
            "volumeWindowWidthChanged",
            function(e) {
              alViewer.setVolumeWindowWidth(e.detail);
            },
            false
          );
        });
      }

      function nextState(s) {

        state = Object.assign({}, state, s);

        if (state.src && state.src !== prevState.src) {
          alViewer.load(state.src);
        }

        if (state.src) {
          alControlPanel.url = state.src;
        }

        if (!state.srcLoaded) {
          debug.classList.add("disabled");
        } else {
          debug.classList.remove("disabled");
        }

        alControlPanel.angles = state.angles;
        alControlPanel.displayMode = state.displayMode;
        alControlPanel.edges = state.edges;
        alControlPanel.nodes = state.nodes;
        alControlPanel.selected = state.selected;

        prevState = Object.assign({}, state);
      }

      document.addEventListener("DOMContentLoaded", function(event) {
        init();
        resize();
      });

      function resize() {
        container.style.height = window.innerHeight + "px";
        if (alViewer.resize) {
          // scene will resize internally as it listens to window.onresize. however, it's useful to be able to force a resize if the window.onresize event isn't fired
          alViewer.resize();
        }
      }

      window.addEventListener("resize", function() {
        resize();
      });

    </script>

  </body>
</html>
